name: Daily AI Pulse Collection

on:
  schedule:
    # 1pm GMT daily (before US market opens at 2:30pm GMT)
    - cron: '0 13 * * *'
  workflow_dispatch:  # Manual trigger button

jobs:
  collect-analyze-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Circuit breaker: hard kill after 30 mins

    steps:
      - name: Checkout ai-pulse (private)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Collect news from all sources
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        run: |
          python3 agents/collector.py \
            --hn-limit 20 \
            --news-limit 30 \
            --sec-days 7 \
            --github-days 7 \
            --github-stars 500 \
            --ir-days 7

      - name: Run semantic deduplication
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 agents/semantic_deduplicator.py --days 7

      - name: Analyze events with Claude Haiku (beta - cost optimized)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 agents/analyzer.py --limit 50

      - name: Debug database state
        run: |
          echo "=== Events with significance_score ==="
          sqlite3 ai_pulse.db "SELECT id, title, significance_score, sentiment FROM events WHERE significance_score IS NOT NULL LIMIT 10;"
          echo ""
          echo "=== Events without significance_score ==="
          sqlite3 ai_pulse.db "SELECT id, title, significance_score FROM events WHERE significance_score IS NULL LIMIT 10;"
          echo ""
          echo "=== Total counts ==="
          sqlite3 ai_pulse.db "SELECT COUNT(*) as total, SUM(CASE WHEN significance_score IS NOT NULL THEN 1 ELSE 0 END) as analyzed FROM events;"

      - name: Check database has events
        id: check_events
        run: |
          EVENT_COUNT=$(sqlite3 ai_pulse.db "SELECT COUNT(*) FROM events WHERE significance_score IS NOT NULL;" 2>/dev/null || echo "0")
          echo "Event count: $EVENT_COUNT"
          if [ "$EVENT_COUNT" -gt 0 ]; then
            echo "has_events=true" >> $GITHUB_OUTPUT
          else
            echo "has_events=false" >> $GITHUB_OUTPUT
            echo "WARNING: No analyzed events found - skipping briefing publish"
          fi

      - name: Generate briefing HTML
        if: steps.check_events.outputs.has_events == 'true'
        run: python3 publish_briefing.py --days 7 --min-score 0

      - name: Commit database to private repo
        run: |
          git config user.name "AI Pulse Bot"
          git config user.email "bot@ai-pulse.local"
          ls -la ai_pulse.db
          git add -f ai_pulse.db
          git add briefings/*.html index.html archive.html || true
          git diff --staged --quiet || git commit -m "Daily collection $(date -u +%Y-%m-%d)"
          git push || echo "Nothing to push"

      - name: Prepare briefings for public repo
        if: steps.check_events.outputs.has_events == 'true'
        run: |
          mkdir -p output
          cp -r briefings output/
          cp index.html output/
          cp archive.html output/
          cp style.css output/

      - name: Push to public briefings repo
        if: steps.check_events.outputs.has_events == 'true'
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.BRIEFINGS_DEPLOY_KEY }}
        with:
          source-directory: 'output'
          destination-github-username: 'mat-e-exp'
          destination-repository-name: 'ai-pulse-briefings'
          target-branch: main
          commit-message: 'Daily briefing ${{ github.run_id }}'

      - name: Log run summary
        run: |
          echo "## Daily Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY

      - name: Notify Discord
        if: always()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"AI-Pulse daily collection: ${{ job.status }}\"}"
