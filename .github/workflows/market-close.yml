name: Market Close Data Collection

on:
  schedule:
    # 9:30pm GMT Monday-Friday only (after US market closes at 9pm GMT)
    # Markets closed on weekends - no data to collect
    - cron: '30 21 * * 1-5'
  workflow_dispatch:  # Manual trigger button

jobs:
  collect-market-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout ai-pulse (private)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Collect market data
        id: market_data
        env:
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
        run: |
          python3 agents/market_collector.py
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "market_open=true" >> $GITHUB_OUTPUT
          else
            echo "market_open=false" >> $GITHUB_OUTPUT
          fi

      - name: Update market status in predictions
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          if [ "${{ steps.market_data.outputs.market_open }}" == "true" ]; then
            echo "Marking $TODAY as market open"
            sqlite3 ai_pulse.db "UPDATE predictions SET market_status='open' WHERE date='$TODAY'"
          else
            echo "Marking $TODAY as market closed"
            sqlite3 ai_pulse.db "UPDATE predictions SET market_status='closed' WHERE date='$TODAY'"
          fi

      - name: Calculate correlation
        if: steps.market_data.outputs.market_open == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -f "agents/correlation_calculator.py" ]; then
            python3 agents/correlation_calculator.py
          else
            echo "Correlation calculator not found, skipping"
          fi

      - name: Check database has events
        id: check_events
        run: |
          EVENT_COUNT=$(sqlite3 ai_pulse.db "SELECT COUNT(*) FROM events WHERE significance_score IS NOT NULL;" 2>/dev/null || echo "0")
          echo "Event count: $EVENT_COUNT"
          if [ "$EVENT_COUNT" -gt 0 ]; then
            echo "has_events=true" >> $GITHUB_OUTPUT
          else
            echo "has_events=false" >> $GITHUB_OUTPUT
            echo "WARNING: No analyzed events found - skipping briefing publish"
          fi

      - name: Regenerate briefing with market data
        if: steps.check_events.outputs.has_events == 'true'
        run: python3 publish_briefing.py --days 7 --min-score 0

      - name: Commit database to private repo
        run: |
          git config user.name "AI Pulse Bot"
          git config user.email "bot@ai-pulse.local"
          git add ai_pulse.db || true
          git add briefings/*.html index.html archive.html || true
          git diff --staged --quiet || git commit -m "Market close $(date -u +%Y-%m-%d)"
          git push || echo "Nothing to push"

      - name: Prepare briefings for public repo
        if: steps.check_events.outputs.has_events == 'true'
        run: |
          mkdir -p output
          cp -r briefings output/
          cp index.html output/
          cp archive.html output/
          cp style.css output/

      - name: Push updated briefing to public repo
        if: steps.check_events.outputs.has_events == 'true'
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.BRIEFINGS_DEPLOY_KEY }}
        with:
          source-directory: 'output'
          destination-github-username: 'mat-e-exp'
          destination-repository-name: 'ai-pulse-briefings'
          target-branch: main
          commit-message: 'Market close update ${{ github.run_id }}'

      - name: Save database artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-pulse-db-market-${{ github.run_id }}
          path: ai_pulse.db
          retention-days: 7

      - name: Log run summary
        run: |
          echo "## Market Close Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY

      - name: Notify Discord
        if: steps.check_events.outputs.has_events == 'true'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "ðŸ“Š **Market data updated**\n\nBriefing refreshed with end-of-day market correlation.\n\nhttps://mat-e-exp.github.io/ai-pulse-briefings/"}'
