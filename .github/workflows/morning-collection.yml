name: Morning Collection (6am)

on:
  schedule:
    # 6am GMT daily - collect overnight news
    - cron: '0 6 * * *'
  workflow_dispatch:  # Manual trigger button

jobs:
  collect-only:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout ai-pulse (private)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Collect news from all sources
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          python3 agents/collector.py \
            --hn-limit 20 \
            --news-limit 50 \
            --sec-days 1 \
            --github-days 1 \
            --github-stars 500 \
            --ir-days 1 \
            --rss-days 1 \
            --rss-limit 10

      - name: Show collection stats
        run: |
          echo "=== Collection Summary ==="
          sqlite3 ai_pulse.db "SELECT source, COUNT(*) as count FROM events WHERE date(collected_at) = date('now') GROUP BY source;"
          echo ""
          echo "=== Total collected today ==="
          sqlite3 ai_pulse.db "SELECT COUNT(*) FROM events WHERE date(collected_at) = date('now');"

      - name: Commit database to private repo
        run: |
          git config user.name "AI Pulse Bot"
          git config user.email "bot@ai-pulse.local"
          git add -f ai_pulse.db
          git commit -m "Morning collection $(date -u +%Y-%m-%d)" || echo "Nothing new to commit"
          git push || echo "Nothing to push"

      - name: Log run summary
        run: |
          echo "## Morning Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: 6am GMT" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Collection only (analysis at 1:30pm)" >> $GITHUB_STEP_SUMMARY
