name: Morning Collection (6am)

on:
  schedule:
    # 6am GMT daily - collect and analyze overnight news
    - cron: '0 6 * * *'
  workflow_dispatch:  # Manual trigger button

jobs:
  collect-analyze-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout ai-pulse (private)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Collect news from all sources
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          python3 agents/collector.py \
            --hn-limit 20 \
            --news-limit 50 \
            --sec-days 1 \
            --github-days 1 \
            --github-stars 500 \
            --ir-days 1 \
            --rss-days 1 \
            --rss-limit 10

      - name: Run semantic deduplication
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 agents/semantic_deduplicator.py --days 1

      - name: Analyze events with Claude Haiku
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python3 agents/analyzer.py --limit 50

      - name: Show collection stats
        run: |
          echo "=== Collection Summary ==="
          sqlite3 ai_pulse.db "SELECT source, COUNT(*) as count FROM events WHERE date(collected_at) = date('now') GROUP BY source;"
          echo ""
          echo "=== Total collected today ==="
          sqlite3 ai_pulse.db "SELECT COUNT(*) FROM events WHERE date(collected_at) = date('now');"
          echo ""
          echo "=== Analyzed today ==="
          sqlite3 ai_pulse.db "SELECT COUNT(*) FROM events WHERE date(collected_at) = date('now') AND significance_score IS NOT NULL;"

      - name: Generate Discord message
        run: python3 agents/discord_morning.py --output discord_message.txt

      - name: Commit database to private repo
        run: |
          git config user.name "AI Pulse Bot"
          git config user.email "bot@ai-pulse.local"
          git add -f ai_pulse.db
          git commit -m "Morning collection $(date -u +%Y-%m-%d)" || echo "Nothing new to commit"
          git push || echo "Nothing to push"

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MESSAGE=$(cat discord_message.txt)
          # Discord has 2000 char limit, truncate if needed
          if [ ${#MESSAGE} -gt 1900 ]; then
            MESSAGE="${MESSAGE:0:1900}..."
          fi
          # Escape for JSON
          MESSAGE_JSON=$(echo "$MESSAGE" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))')
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"content\": $MESSAGE_JSON}"

      - name: Save database artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-pulse-db-morning-${{ github.run_id }}
          path: ai_pulse.db
          retention-days: 7

      - name: Log run summary
        run: |
          echo "## Morning Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: 6am GMT" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Collected, analyzed, Discord notified" >> $GITHUB_STEP_SUMMARY
