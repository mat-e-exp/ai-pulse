name: Deploy to Preview

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  deploy-preview:
    # Only run if PR was merged (not just closed) and was from issue agent
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'issue-')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate preview briefing
        run: python3 publish_briefing.py --days 7 --min-score 0

      - name: Prepare preview output
        run: |
          mkdir -p output/preview
          cp -r briefings output/preview/
          cp index.html output/preview/
          cp archive.html output/preview/
          cp style.css output/preview/

      - name: Push preview to public repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.BRIEFINGS_DEPLOY_KEY }}
        with:
          source-directory: 'output/preview'
          destination-github-username: 'mat-e-exp'
          destination-repository-name: 'ai-pulse-briefings'
          target-branch: main
          target-directory: 'preview'
          commit-message: 'Preview: ${{ github.event.pull_request.title }}'

      - name: Notify Discord - Preview Ready
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_APPROVALS }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸ‘€ **Preview Ready**\n\n**Change:** ${{ github.event.pull_request.title }}\n**Preview:** https://mat-e-exp.github.io/ai-pulse-briefings/preview/\n\nIf it looks good, add label \`promote:prod\` to the original issue to deploy to production.\"}"
